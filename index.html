<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ú©Ø§ØªØ§Ù„ÙˆÚ¯ Ù¾Ø®Ø´ Ù¾Ø§Ø±Ø§Ø¯Ø§ÛŒØ³</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#5b2aa6" />

<style>
:root{
  --brand:#5b2aa6; --brand-soft:#7a3ef2;
  --bg:#f6f7fb; --card:#fff; --text:#222; --muted:#666;
  --ok:#12a150; --bad:#d54b4b; --radius:18px;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 Vazirmatn,IRANSans,system-ui}
header{background:var(--brand);color:#fff;padding:22px 16px;text-align:center;position:sticky;top:0;z-index:5}
h1{margin:0;font-weight:800}

.search-wrap{display:flex;justify-content:center;margin:16px 0}
.search{width:min(720px,92%);padding:10px 14px;border-radius:999px;border:0;outline:0;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.06)}

.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;padding:12px;width:min(1400px,98%);margin:0 auto}
@media(max-width:1000px){.grid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:800px){.grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:560px){.grid{grid-template-columns:repeat(3,1fr)}}

.card{background:var(--card);border-radius:var(--radius);box-shadow:0 4px 10px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column;transition:transform .2s ease}
.card:hover{transform:translateY(-3px)}
.card img{width:100%;aspect-ratio:3/4;object-fit:cover;object-position:center;background:#eee}
.card-body{padding:8px}
.title{font-weight:700;font-size:.9rem;line-height:1.3;margin-bottom:4px}
.meta{font-size:.75rem;color:var(--muted);margin-bottom:4px}

.row{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.stock-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.stock-dot.ok{background:#12a150}
.stock-dot.bad{background:#d54b4b}
.stock-text{font-weight:700;color:#222;font-size:.8rem}

.cart-controls{display:flex;align-items:center;gap:6px;margin-top:6px;flex-wrap:wrap;font-size:.85rem}
.btn-qty{background:var(--brand-soft);color:#fff;border:none;width:28px;height:28px;font-size:15px;border-radius:8px;cursor:pointer;transition:.2s filter}
.btn-qty:hover{filter:brightness(.92)}
.qty-input{width:56px;text-align:center;border:1px solid #ccc;border-radius:8px;padding:3px;font-family:inherit;font-size:.8rem;background:#fff}
.hint{font-size:.75rem;color:#999;flex-basis:100%}

.empty,.loading{text-align:center;color:var(--muted);padding:28px}

#cart-btn{position:fixed;bottom:20px;left:20px;background:var(--brand);color:#fff;border:none;border-radius:999px;padding:14px 20px;font-weight:700;font-size:1rem;box-shadow:0 6px 18px rgba(0,0,0,.25);cursor:pointer;z-index:100}

#cart-panel{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:200}
#cart-panel.active{display:flex}
.cart-box{background:#fff;border-radius:20px;padding:24px;width:min(500px,90%);max-height:80vh;overflow:auto;box-shadow:0 8px 30px rgba(0,0,0,.25);animation:pop .3s ease}
@keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
.cart-item{padding:6px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
.cart-actions{display:flex;justify-content:space-between;align-items:center;margin-top:16px}
.btn-close{background:#ccc;border:none;padding:6px 12px;border-radius:8px;cursor:pointer}
.btn-wa{background:#25D366;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:600;cursor:pointer}
.btn-remove{background:#ffdddd;border:none;color:#d33;border-radius:6px;padding:3px 6px;cursor:pointer;font-size:.75rem}
</style>
</head>

<body>
<header><h1>Ú©Ø§ØªØ§Ù„ÙˆÚ¯ Ù¾Ø®Ø´ Ù¾Ø§Ø±Ø§Ø¯Ø§ÛŒØ³</h1></header>

<main>
  <div class="search-wrap"><input id="q" class="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ù†Ø§Ù…ØŒ Ú©Ø¯ØŒ ÛŒØ§ Ø¯Ø³ØªÙ‡â€¦"></div>
  <div class="grid" id="grid"></div>
  <div class="loading" id="loading">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒâ€¦</div>
  <div class="empty" id="empty" style="display:none">Ù…ÙˆØ±Ø¯ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</div>
</main>

<button id="cart-btn">ğŸ›’ Ø³Ø¨Ø¯ (<span id="cart-count">0</span>)</button>

<div id="cart-panel">
  <div class="cart-box">
    <h2>Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±</h2>
    <div id="cart-list"></div>
    <div class="cart-actions">
      <button class="btn-close">Ø¨Ø³ØªÙ†</button>
      <button class="btn-wa" id="wa-send" style="display:none;">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ù¾</button>
    </div>
  </div>
</div>

<script>
/* ===== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ===== */
// Ø¨Ø§Ù„Ø§ÛŒ ÙØ§ÛŒÙ„ØŒ Ú©Ù†Ø§Ø± Ø¨Ù‚ÛŒÙ‡ Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§
const API_BASE  = 'https://script.google.com/macros/s/AKfycbzrCIodUxmniS1HgUwf-SirQIyujPYhYVe3OwEjsBsxi2fxWsg-uPWqEgDC_k3ICAi6SA/exec';
const TELE_PROXY = 'https://script.google.com/macros/s/AKfycbzrCIodUxmniS1HgUwf-SirQIyujPYhYVe3OwEjsBsxi2fxWsg-uPWqEgDC_k3ICAi6SA/exec';
const PAGE_SIZE = 48;
let allItems = [];
const cart = {};

/* ===== Ø¹Ù†Ø§ØµØ± ===== */
const elGrid = document.getElementById('grid');
const elCartBtn = document.getElementById('cart-btn');
const elCartCount = document.getElementById('cart-count');
const elCartPanel = document.getElementById('cart-panel');
const elCartList = document.getElementById('cart-list');
const elWASend = document.getElementById('wa-send');
const elQ = document.getElementById('q');
const elLoading = document.getElementById('loading');
const elEmpty = document.getElementById('empty');

/* ===== Ú©Ø§Ø±Øª Ù…Ø­ØµÙˆÙ„ ===== */
function cardHTML(it){
  const PLACEHOLDER =
    'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="600" height="800">
         <rect width="100%" height="100%" fill="#eee"/>
         <text x="50%" y="50%" fill="#999" font-size="28" text-anchor="middle" dominant-baseline="middle">Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±</text>
       </svg>`);

  const isUrl = /^https?:\/\//i.test((it.photo_endpoint||'').trim());
  const hasProxy = TELE_PROXY && it.photo;
  const imgSrc = /^https?:\/\//i.test((it.photo_endpoint||'').trim())
  ? it.photo_endpoint
  : (it.photo
      ? `${TELE_PROXY}?fn=tg-image&fid=${encodeURIComponent(it.photo)}`
      : PLACEHOLDER);

  const available = Number(it.qty||0) > 0;
  const stockHTML = available
    ? `<span class="stock-dot ok"></span><span class="stock-text">Ù…ÙˆØ¬ÙˆØ¯</span>`
    : `<span class="stock-dot bad"></span><span class="stock-text">Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯</span>`;

  // Ø§Ú¯Ø± Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯ØŒ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ù†Ø¯Ù‡
  const controls = available ? `
    <div class="cart-controls">
      <button class="btn-qty" data-op="minus" data-code="${it.code}" data-name="${it.name}">âˆ’</button>
      <input type="number" class="qty-input" min="1" value="${cart[it.code]?.qty || 1}" data-code="${it.code}" data-name="${it.name}">
      <button class="btn-qty" data-op="plus" data-code="${it.code}" data-name="${it.name}">+</button>
      <span class="hint">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.</span>
    </div>` : '';

  return `<div class="card">
    <img src="${imgSrc}" alt="${it.name||''}">
    <div class="card-body">
      <div class="title">${it.name||'-'}</div>
      <div class="meta">Ú©Ø¯: ${it.code||'-'}</div>
      <div class="row">${stockHTML}</div>
      ${controls}
    </div>
  </div>`;
}

/* ===== API ===== */
async function fetchPage(page, q=""){
  const url = new URL(API_BASE);
  url.searchParams.set('fn','products');
  url.searchParams.set('page',page);
  url.searchParams.set('pagesize',PAGE_SIZE);
  if(q) url.searchParams.set('q', q);
  const res = await fetch(url.toString(), { cache: 'no-store' });
  if(!res.ok) throw new Error('network');
  return res.json();
}

/* ===== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ===== */
async function loadAll(q=""){
  elLoading.style.display = 'block';
  elEmpty.style.display = 'none';
  try{
    const data = await fetchPage(0, q);
    allItems = data.items || [];
    elGrid.innerHTML = allItems.map(cardHTML).join('');
    if(allItems.length === 0) elEmpty.style.display = 'block';
  }catch(e){
    elGrid.innerHTML = '';
    elEmpty.style.display = 'block';
    elEmpty.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª.';
  }finally{
    elLoading.style.display = 'none';
  }
}

/* ===== Ø¬Ø³ØªØ¬Ùˆ (Ø¯ÛŒØ¨Ø§Ù†Ø³) ===== */
let qTimer = null;
elQ.addEventListener('input', ()=>{
  const q = elQ.value.trim();
  if(qTimer) clearTimeout(qTimer);
  qTimer = setTimeout(()=> loadAll(q), 300);
});

/* ===== Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ ===== */
function updateCartCount(){
  const total = Object.values(cart).reduce((a,b)=>a+(b.qty||0),0);
  elCartCount.textContent = total;
  elWASend.style.display = total>0 ? 'inline-block' : 'none';
}
function renderCart(){
  if(Object.keys(cart).length===0){
    elCartList.innerHTML='<p>Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>';
    elWASend.style.display='none';
    return;
  }
  elWASend.style.display='inline-block';
  elCartList.innerHTML = Object.entries(cart).map(([code,it])=>`
    <div class="cart-item">
      <span>${it.name} â€” (${code}) Ã— ${it.qty}</span>
      <div>
        <button class="btn-remove" data-code="${code}">Ø­Ø°Ù</button>
      </div>
    </div>`).join('');
}
function openCart(){ renderCart(); elCartPanel.classList.add('active'); }

/* ÙˆØ§ØªØ³Ø§Ù¾ */
function makeWAurl(){
  let txt = `ğŸ’œ *Ù¾Ø®Ø´ Ù¾Ø§Ø±Ø§Ø¯Ø§ÛŒØ³ | Paradise Distribution*\nğŸ§¾ *Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø³ÙØ§Ø±Ø´*\n\n`;
  Object.entries(cart).forEach(([c,info],i)=>{
    txt += `${i+1}. ${info.name} (Ú©Ø¯ ${c}) â€” ${info.qty} Ø¹Ø¯Ø¯\n`;
  });
  txt += `\nØ§Ø±Ø³Ø§Ù„ Ø§Ø² Ú©Ø§ØªØ§Ù„ÙˆÚ¯ Ø±Ø³Ù…ÛŒ Ù¾Ø§Ø±Ø§Ø¯Ø§ÛŒØ³`;
  return `https://wa.me/989027898758?text=${encodeURIComponent(txt)}`;
}

/* ===== Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ===== */
document.body.addEventListener('click', e=>{
  // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ +/âˆ’
  const qtyBtn = e.target.closest('.btn-qty');
  if(qtyBtn){
    const code = qtyBtn.dataset.code;
    const name = qtyBtn.dataset.name || '';
    const input = document.querySelector(`.qty-input[data-code="${code}"]`);
    let val = parseInt(input.value,10) || 1;
    val = qtyBtn.dataset.op==='plus' ? val+1 : Math.max(1, val-1);
    input.value = val;
    // Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Ø³Ø¨Ø¯
    cart[code] = { name, qty: val };
    updateCartCount();
  }

  if(e.target.matches('#cart-btn')) openCart();
  if(e.target.matches('.btn-close')) elCartPanel.classList.remove('active');
  if(e.target.matches('.btn-remove')){
    const code = e.target.dataset.code;
    delete cart[code];
    updateCartCount();
    renderCart();
  }
  if(e.target.matches('.btn-wa')) window.open(makeWAurl(),'_blank');
});

// ØªØºÛŒÛŒØ± Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø®Ù„ input Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø¨Ù‡ Ø³Ø¨Ø¯ ÙˆØµÙ„ Ú©Ù†Ø¯
document.body.addEventListener('input', e=>{
  const inp = e.target.closest('.qty-input');
  if(!inp) return;
  const code = inp.dataset.code;
  const name = inp.dataset.name || '';
  let val = parseInt(inp.value,10);
  if(isNaN(val) || val < 1) val = 1;
  inp.value = val;
  cart[code] = { name, qty: val };
  updateCartCount();
});

/* Ø´Ø±ÙˆØ¹ */
loadAll();
</script>
</body>
</html>
